<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Prompter (Optimized Teleprompter Mode)</title>

<style>
:root{
  --bg:#0b0f14;
  --panel:#111827;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#38bdf8;
  --border: rgba(148,163,184,.22);
  --radius:16px;
}
*{box-sizing:border-box;}

html{
  height:100%;
  -webkit-text-size-adjust:100%;
}

body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:var(--bg);
  color:var(--text);
  height:100%;
  overflow:hidden;
  touch-action:manipulation;
}

.stage{
  height:100dvh;
  width:100vw;
  overflow:hidden;
  position:relative;
  padding:env(safe-area-inset-top)
          env(safe-area-inset-right)
          env(safe-area-inset-bottom)
          env(safe-area-inset-left);
}

/* ===== PROMPTER ===== */
.prompter{
  height:100%;
  width:100%;
  overflow:auto;
  border:1px solid var(--border);
  border-radius:var(--radius);
  background:rgba(17,24,39,.22);
  -webkit-overflow-scrolling:touch;
}

.marker{
  position:sticky;
  top:45%;
  border-top:2px solid rgba(56,189,248,.6);
  margin:0 1rem;
  z-index:2;
}

.content{
  padding:18vh 6vw 28vh;
  font-size:clamp(32px,5vw,50px);
  line-height:1.55;
  white-space:pre-wrap;
  word-break:break-word;
}

/* ===== MENU ===== */
.menu{
  position:absolute;
  top:10px;
  left:10px;
  bottom:10px;
  width:90%;
  max-width:380px;
  background:rgba(17,24,39,.92);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:10px;
  z-index:10;
  transition:.25s;
}
.menu.is-collapsed{transform:translateX(-110%);}

button{
  border:1px solid var(--border);
  background:rgba(17,24,39,.95);
  padding:.6rem .8rem;
  border-radius:14px;
  color:var(--text);
}

textarea{
  width:100%;
  min-height:120px;
  background:rgba(17,24,39,.65);
  border:1px solid var(--border);
  border-radius:14px;
  padding:.8rem;
  font-size:16px;
  color:var(--text);
}

/* ===== STAGE HUD ===== */
.stageHUD{
  position:absolute;
  right:14px;
  bottom:14px;
  display:none;
  gap:12px;
  padding:12px;
  border-radius:999px;
  background:rgba(17,24,39,.88);
  border:1px solid var(--border);
  z-index:50;
}
.stageHUD button{
  width:68px;
  height:68px;
  border-radius:999px;
  font-size:22px;
}

.dot{
  width:10px;
  height:10px;
  border-radius:50%;
  display:inline-block;
  margin-right:6px;
  background:#666;
}
.dot.live{
  background:var(--accent);
  box-shadow:0 0 0 4px rgba(56,189,248,.18);
}

.status{font-size:13px;color:var(--muted);}
</style>
</head>

<body>
<div class="stage">

  <aside class="menu" id="menu">
    <div><span class="dot" id="dot"></span>Prompter</div>
    <div class="status" id="status">Bereit.</div>

    <button id="btnStart">üéôÔ∏è Voice-Follow</button>
    <button id="btnStop">‚èπ Stop</button>
    <button id="btnStage">üé¨ Stage</button>

    <textarea id="text" placeholder="Vortragstext einf√ºgen..."></textarea>
  </aside>

  <div class="stageHUD" id="stageHUD">
    <button id="hudVoice">üéô</button>
    <button id="hudFull">‚õ∂</button>
    <button id="hudMenu">‚ò∞</button>
  </div>

  <main class="prompter" id="prompter">
    <div class="marker"></div>
    <div class="content" id="content"></div>
  </main>

</div>

<script>
const elText=document.getElementById('text');
const elContent=document.getElementById('content');
const elPrompter=document.getElementById('prompter');
const dot=document.getElementById('dot');
const menu=document.getElementById('menu');
const stageHUD=document.getElementById('stageHUD');
const status=document.getElementById('status');

const btnStart=document.getElementById('btnStart');
const btnStop=document.getElementById('btnStop');
const btnStage=document.getElementById('btnStage');
const hudVoice=document.getElementById('hudVoice');
const hudFull=document.getElementById('hudFull');
const hudMenu=document.getElementById('hudMenu');

elText.addEventListener('input',()=>elContent.textContent=elText.value);
elContent.textContent="‚¨ÖÔ∏è Text einf√ºgen...";

/* ===== TELEPROMPTER LOGIK ===== */

function normalize(s){
  return s.toLowerCase().replace(/[^a-z0-9√§√∂√º√ü\s]/g,'').replace(/\s+/g,' ').trim();
}

function scrollToMatch(rawText,matchIdxNorm){
  if(matchIdxNorm<0)return;

  const norm=normalize(rawText);

  // ‚úÖ VORLAUF 0.03
  const lead=Math.floor(norm.length*0.03);
  const idx=Math.min(norm.length,matchIdxNorm+lead);
  const ratio=norm.length?idx/norm.length:0;

  const maxScroll=elPrompter.scrollHeight-elPrompter.clientHeight;

  // ‚úÖ Position 0.45 (leicht √ºber Mitte)
  const desiredViewportPosition=0.45;
  const offset=elPrompter.clientHeight*desiredViewportPosition;
  const target=ratio*maxScroll;

  elPrompter.scrollTop=Math.max(0,target-offset);
}

/* ===== STAGE MODE ===== */
let stageMode=false;
btnStage.onclick=()=>{
  stageMode=!stageMode;
  stageHUD.style.display=stageMode?'flex':'none';
  menu.classList.toggle('is-collapsed',stageMode);
};

hudMenu.onclick=()=>menu.classList.toggle('is-collapsed');
hudFull.onclick=()=>document.documentElement.requestFullscreen();

/* ===== SPEECH ===== */
const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
let rec;

btnStart.onclick=()=>{
  if(!SpeechRecognition)return alert("Chrome verwenden");
  rec=new SpeechRecognition();
  rec.lang="de-DE";
  rec.continuous=true;
  rec.interimResults=true;

  rec.onstart=()=>{
    dot.classList.add("live");
    status.textContent="üéôÔ∏è l√§uft...";
  };

  rec.onresult=(ev)=>{
    let combined="";
    for(let i=ev.resultIndex;i<ev.results.length;i++){
      combined+=ev.results[i][0].transcript+" ";
    }
    const raw=elText.value;
    const textNorm=normalize(raw);
    const match=textNorm.indexOf(normalize(combined.trim()));
    if(match>=0)scrollToMatch(raw,match);
  };

  rec.onend=()=>{
    dot.classList.remove("live");
    status.textContent="Beendet.";
  };

  rec.start();
};

btnStop.onclick=()=>rec&&rec.stop();
hudVoice.onclick=()=>rec?rec.stop():btnStart.click();

</script>
</body>
</html>
